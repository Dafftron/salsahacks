var e=Object.defineProperty,s=Object.defineProperties,a=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,t=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable,n=(s,a,r)=>a in s?e(s,a,{enumerable:!0,configurable:!0,writable:!0,value:r}):s[a]=r,i=(e,s)=>{for(var a in s||(s={}))t.call(s,a)&&n(e,a,s[a]);if(r)for(var a of r(s))l.call(s,a)&&n(e,a,s[a]);return e},o=(e,r)=>s(e,a(r)),c=(e,s,a)=>new Promise((r,t)=>{var l=e=>{try{i(a.next(e))}catch(s){t(s)}},n=e=>{try{i(a.throw(e))}catch(s){t(s)}},i=e=>e.done?r(e.value):Promise.resolve(e.value).then(l,n);i((a=a.apply(e,s)).next())});import{u as d,j as m,r as u,v as x}from"../assets/index-_E1YfA--.js";import{r as h}from"./vendor-react-SlK7pBj5.js";import{u as p,b as v,g}from"./index-DxznKFAT.js";import{u as b}from"./CompactCardActions-Bres0XMd.js";import f from"./Toast-DEMKkBqT.js";import y from"./VideoPlayer-BonkY548.js";import{LucideUpload as j,LucideX as w,LucideTrash2 as N,ChevronsDown as $,ChevronsUp as k,ChevronDown as P,ChevronUp as R,AlertCircle as U}from"./vendor-icons-BWQzNHDY.js";import"./vendor-router-UcgXoTZX.js";import"./vendor-firebase-DVYjp8kH.js";const L=({isOpen:e,onClose:s,onVideoUploaded:a,page:r="figuras",style:t="salsa"})=>{const{user:l}=d(),{currentCategories:n,categoriesList:L,getGradientClasses:E}=b(r,t),O=h.useRef(null),[S,C]=h.useState([]),[T,z]=h.useState(!1),[V,D]=h.useState({}),[B,F]=h.useState(1),[M,I]=h.useState({}),[A,_]=h.useState([]),[q,H]=h.useState({}),W=h.useRef({}),[G,K]=h.useState(new Set);h.useEffect(()=>{e?F(1):X()},[e]),h.useEffect(()=>{if(n){const e={};Object.keys(n).forEach(s=>{e[s]=[]}),H(e)}},[n]);const X=()=>{Object.values(M).forEach(e=>{e.videoPreview&&URL.revokeObjectURL(e.videoPreview),e.thumbnailPreview&&URL.revokeObjectURL(e.thumbnailPreview)}),C([]),I({}),K(new Set),D({}),z(!1),F(1),O.current&&(O.current.value="")},J=(e,s="success")=>{const a=Date.now();_(r=>[...r,{id:a,message:e,type:s}])},Q=e=>{K(e?new Set(S.map(e=>e.name)):new Set)},Y=e=>{const s=Array.from(e.target.files).filter(e=>e.type.startsWith("video/"));if(0===s.length)return void J("Por favor selecciona archivos de video v치lidos","error");const a=s.filter(e=>!S.some(s=>s.name===e.name));0!==a.length?(C(e=>[...e,...a]),a.forEach(e=>c(void 0,null,function*(){const s=URL.createObjectURL(e);try{const a=yield Z(e),r=URL.createObjectURL(a);I(a=>o(i({},a),{[e.name]:o(i({},a[e.name]),{videoPreview:s,thumbnailPreview:r})}))}catch(a){I(a=>o(i({},a),{[e.name]:o(i({},a[e.name]),{videoPreview:s})}))}})),J(`${a.length} video(s) agregado(s)`,"success")):J("Algunos archivos ya est치n seleccionados","warning")},Z=e=>c(void 0,null,function*(){return new Promise((s,a)=>{try{const r=URL.createObjectURL(e),t=document.createElement("video");t.crossOrigin="anonymous",t.muted=!0,t.playsInline=!0;const l=document.createElement("canvas"),n=l.getContext("2d");l.width=1280,l.height=720,t.onloadedmetadata=()=>{try{t.currentTime=.1,t.onseeked=()=>{try{n.drawImage(t,0,0,l.width,l.height),l.toBlob(e=>{e?(URL.revokeObjectURL(r),t.remove(),l.remove(),s(e)):a(new Error("No se pudo generar el thumbnail por defecto"))},"image/jpeg",.95)}catch(e){a(new Error(`Error al capturar frame por defecto: ${e.message}`))}},t.onerror=()=>{a(new Error("Error al cargar el video para thumbnail por defecto"))}}catch(e){a(new Error(`Error al procesar metadata por defecto: ${e.message}`))}},t.onerror=()=>{URL.revokeObjectURL(r),t.remove(),l.remove(),a(new Error("Error al cargar el video por defecto"))},t.src=r}catch(r){a(new Error(`Error al generar thumbnail por defecto: ${r.message}`))}})}),ee=(e,s)=>c(void 0,null,function*(){var a,n,d,m;try{if((yield u(e.name,r)).isDuplicate)return J(`Video "${e.name}" ya existe en ${"escuela"===r?"Escuela":"Figuras"}`,"warning"),null;const b=yield(e=>c(void 0,null,function*(){var s;try{if(null==(s=M[e.name])?void 0:s.customThumbnailFile){const s=M[e.name].customThumbnailFile,a=`thumbnails/${r}/${t}/${Date.now()}_${e.name.replace(/\.[^/.]+$/,".jpg")}`,l=yield v(s,a);if(l.success)return{url:l.url,path:l.path}}try{const s=yield Promise.race([g(e),new Promise((e,s)=>setTimeout(()=>s(new Error("Timeout")),15e3))]);if(s.success&&s.blob){const a=`thumbnails/${r}/${t}/${Date.now()}_${e.name.replace(/\.[^/.]+$/,".jpg")}`,l=yield v(s.blob,a);if(l.success)return s.thumbnailURL&&URL.revokeObjectURL(s.thumbnailURL),{url:l.url,path:l.path}}}catch(a){}try{const s=yield Z(e);if(s){const a=`thumbnails/${r}/${t}/${Date.now()}_${e.name.replace(/\.[^/.]+$/,".jpg")}`,l=yield v(s,a);if(l.success)return{url:l.url,path:l.path}}}catch(l){}return{url:null,path:null}}catch(n){return{url:null,path:null}}}))(e),f=`videos/${r}/${t}/${Date.now()}_${e.name}`,y=yield p(e,f,e=>{D(a=>o(i({},a),{[s]:e}))});if(!y.success)return J(`Error al subir ${e.name}: ${y.error}`,"error"),null;const j=o(i({},q),{estilo:q.estilo||[]}),w=W.current[`${e.name}-title`],N=W.current[`${e.name}-description`],$=(null==(a=null==w?void 0:w.value)?void 0:a.trim())||(null==(n=M[e.name])?void 0:n.title)||e.name.replace(/\.[^/.]+$/,""),k=(null==(d=null==N?void 0:N.value)?void 0:d.trim())||(null==(m=M[e.name])?void 0:m.description)||"";let P=null,R=null,U=null;try{const s=document.createElement("video");s.src=URL.createObjectURL(e),yield new Promise((e,a)=>{s.onloadedmetadata=()=>{R=s.videoWidth,U=s.videoHeight;const a=Math.max(R,U);P=a>=3840?"4K":a>=1920?"1080p":a>=1280?"720p":a>=854?"480p":"360p",URL.revokeObjectURL(s.src),e()},s.onerror=a})}catch(h){P="Unknown"}const L={title:$,originalTitle:e.name,description:k,videoUrl:y.url,thumbnailUrl:b.url||null,videoPath:y.path,thumbnailPath:b.path||null,fileSize:e.size,fileType:e.type,duration:0,resolution:P,videoWidth:R,videoHeight:U,style:t,tags:j,uploadedBy:(null==l?void 0:l.uid)||"anonymous",views:0,likes:0,likedBy:[]},E=yield x(L,r);return E.success?(J(`${e.name} subido exitosamente`,"success"),o(i({},L),{id:E.id})):(J(`Error al guardar metadatos de ${e.name}`,"error"),null)}catch(h){return J(`Error inesperado al subir ${e.name}`,"error"),null}}),se=()=>m.jsxs("div",{className:"space-y-4",children:[m.jsxs("div",{className:"text-center",children:[m.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Seleccionar Videos"}),m.jsx("p",{className:"text-gray-600",children:"Selecciona uno o varios videos para subir"})]}),m.jsxs("div",{className:`border-2 border-dashed border-gray-300 rounded-lg p-6 hover:border-${"salsa"===t?"pink":"bachata"===t?"emerald":"kizomba"===t?"amber":"zouk"===t?"violet":"cyan"}-400 transition-colors duration-200`,children:[m.jsx("input",{ref:O,type:"file",multiple:!0,accept:"video/*",onChange:Y,className:"hidden"}),m.jsxs("button",{onClick:()=>{var e;return null==(e=O.current)?void 0:e.click()},className:`w-full flex flex-col items-center justify-center space-y-2 text-gray-600 hover:text-${"salsa"===t?"pink":"bachata"===t?"emerald":"kizomba"===t?"amber":"zouk"===t?"violet":"cyan"}-500 transition-colors duration-200`,children:[m.jsx(j,{className:"h-12 w-12"}),m.jsx("span",{className:"font-medium text-center",children:"Haz clic para seleccionar videos"}),m.jsx("span",{className:"text-sm text-center",children:"MP4, AVI, MOV, etc. (m치x. 500MB cada uno)"})]})]}),S.length>0&&m.jsxs("div",{className:"space-y-2",children:[m.jsxs("h4",{className:"font-medium text-gray-900",children:["Videos seleccionados (",S.length,")"]}),S.map((e,s)=>m.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[m.jsxs("div",{className:"flex-1",children:[m.jsx("p",{className:"font-medium text-gray-900",children:e.name}),m.jsxs("p",{className:"text-sm text-gray-500",children:[(e.size/1048576).toFixed(2)," MB"]})]}),m.jsx("button",{onClick:()=>(e=>{const s=S[e];s&&M[s.name]&&(M[s.name].videoPreview&&URL.revokeObjectURL(M[s.name].videoPreview),M[s.name].thumbnailPreview&&URL.revokeObjectURL(M[s.name].thumbnailPreview)),C(s=>s.filter((s,a)=>a!==e)),I(e=>{const a=i({},e);return delete a[s.name],a}),K(e=>{const a=new Set(e);return a.delete(s.name),a})})(s),className:"p-1 text-red-500 hover:text-red-700 transition-colors duration-200",children:m.jsx(N,{className:"h-4 w-4"})})]},s))]})]}),ae=()=>m.jsxs("div",{className:"space-y-6",children:[m.jsxs("div",{className:"text-center",children:[m.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Configurar Videos"}),m.jsx("p",{className:"text-gray-600",children:"Personaliza la informaci칩n de tus videos antes de subirlos"})]}),S.length>1&&m.jsxs("div",{className:"flex justify-center space-x-2",children:[m.jsxs("button",{onClick:()=>Q(!0),className:"flex items-center space-x-1 px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition-colors",children:[m.jsx($,{className:"h-4 w-4"}),m.jsx("span",{children:"Plegar Todo"})]}),m.jsxs("button",{onClick:()=>Q(!1),className:"flex items-center space-x-1 px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition-colors",children:[m.jsx(k,{className:"h-4 w-4"}),m.jsx("span",{children:"Desplegar Todo"})]})]}),S.map((e,s)=>{var a,r,t,l,n;const c=G.has(e.name);return m.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[m.jsxs("div",{className:"flex items-center justify-between p-4 bg-gray-50 border-b border-gray-200",children:[m.jsxs("div",{className:"flex items-center space-x-3",children:[m.jsxs("div",{className:"w-12 h-9 bg-gray-100 rounded flex items-center justify-center relative overflow-hidden",children:[(null==(a=M[e.name])?void 0:a.thumbnailPreview)?m.jsx("img",{src:M[e.name].thumbnailPreview,alt:"Vista previa del video",className:"w-full h-full object-cover",onError:e=>{e.target.style.display="none",e.target.nextSibling.style.display="flex"}}):null,m.jsx("span",{className:"text-xs text-gray-500",style:{display:(null==(r=M[e.name])?void 0:r.thumbnailPreview)?"none":"flex"},children:"VIDEO"})]}),m.jsxs("div",{children:[m.jsx("h4",{className:"font-medium text-gray-900",children:e.name}),m.jsxs("p",{className:"text-sm text-gray-500",children:[(e.size/1048576).toFixed(2)," MB"]})]})]}),m.jsx("div",{className:"flex items-center space-x-2",children:m.jsx("button",{onClick:()=>{return s=e.name,void K(e=>{const a=new Set(e);return a.has(s)?a.delete(s):a.add(s),a});var s},className:"p-1 text-gray-500 hover:text-gray-700 transition-colors",title:c?"Desplegar":"Plegar",children:c?m.jsx(P,{className:"h-4 w-4"}):m.jsx(R,{className:"h-4 w-4"})})})]}),!c&&m.jsxs("div",{className:"p-4 space-y-4",children:[m.jsxs("div",{className:"space-y-4",children:[m.jsx("h4",{className:"font-medium text-gray-900",children:"Vista previa del video"}),m.jsx("div",{className:"flex justify-center",children:m.jsx(y,{src:(null==(t=M[e.name])?void 0:t.videoPreview)||URL.createObjectURL(e),size:"medium",loop:!0,showControls:!0,autoplay:!1,muted:!1,className:"w-full max-w-2xl",resolutions:["auto","4k","1080p","720p","480p","360p"],currentResolution:"auto",videoTitle:(null==(l=M[e.name])?void 0:l.title)||e.name.replace(/\.[^/.]+$/,""),onResolutionChange:e=>{}})}),m.jsxs("div",{className:"flex items-center justify-between text-sm text-gray-600",children:[m.jsx("span",{children:e.name}),m.jsxs("span",{children:[(e.size/1048576).toFixed(2)," MB"]})]})]}),m.jsxs("div",{className:"space-y-2",children:[m.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Nombre del video"}),m.jsx("input",{type:"text","data-file":e.name,"data-field":"title",ref:s=>{var a;s&&(W.current[`${e.name}-title`]=s,s.value||(s.value=(null==(a=M[e.name])?void 0:a.title)||e.name.replace(/\.[^/.]+$/,"")))},onBlur:s=>{var a;const r=s.target.value.trim();r!==((null==(a=M[e.name])?void 0:a.title)||e.name.replace(/\.[^/.]+$/,""))&&I(s=>o(i({},s),{[e.name]:o(i({},s[e.name]),{title:r})}))},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent",placeholder:"Ingresa un nombre para el video"})]}),m.jsxs("div",{className:"space-y-2",children:[m.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Descripci칩n (opcional)"}),m.jsx("textarea",{"data-file":e.name,"data-field":"description",ref:s=>{var a;s&&(W.current[`${e.name}-description`]=s,s.value||(s.value=(null==(a=M[e.name])?void 0:a.description)||""))},onBlur:s=>{var a;const r=s.target.value.trim();r!==((null==(a=M[e.name])?void 0:a.description)||"")&&I(s=>o(i({},s),{[e.name]:o(i({},s[e.name]),{description:r})}))},rows:2,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent",placeholder:"Describe brevemente el contenido del video..."})]}),m.jsxs("div",{className:"space-y-2",children:[m.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Thumbnail personalizado (opcional)"}),m.jsxs("div",{className:"flex items-center space-x-3",children:[m.jsx("div",{className:"w-40 h-24 bg-gray-100 rounded border-2 border-dashed border-gray-300 flex items-center justify-center overflow-hidden",children:(null==(n=M[e.name])?void 0:n.customThumbnail)?m.jsx("img",{src:M[e.name].customThumbnail,alt:"Thumbnail personalizado",className:"w-full h-full object-cover rounded"}):m.jsx("span",{className:"text-xs text-gray-500",children:"IMG"})}),m.jsx("input",{type:"file",accept:"image/*",onChange:s=>{const a=s.target.files[0];if(a){const s=new FileReader;s.onload=s=>{I(r=>o(i({},r),{[e.name]:o(i({},r[e.name]),{customThumbnail:s.target.result,customThumbnailFile:a})}))},s.readAsDataURL(a)}},className:"flex-1 text-sm text-gray-500 file:mr-4 file:py-1 file:px-3 file:rounded-full file:border-0 file:text-sm file:font-medium file:bg-pink-50 file:text-pink-700 hover:file:bg-pink-100"})]})]})]})]},s)}),m.jsxs("div",{className:"border-t pt-6",children:[m.jsx("h4",{className:"font-medium text-gray-900 mb-4",children:"Etiquetas para todos los videos"}),L.map(e=>m.jsxs("div",{className:"space-y-3 mb-4",children:[m.jsx("h5",{className:"font-medium text-gray-700 capitalize",children:e.name}),m.jsx("div",{className:"flex flex-wrap gap-2",children:e.tags.map(s=>{var a;return m.jsx("button",{onClick:()=>((e,s)=>{H(a=>{const r=a[e]||[];if(r.includes(s))return o(i({},a),{[e]:r.filter(e=>e!==s)});{const t=[...new Set([...r,s])];return o(i({},a),{[e]:t})}})})(e.key,s),className:"px-3 py-1 rounded-full text-sm font-medium transition-all duration-200 "+((null==(a=q[e.key])?void 0:a.includes(s))?`bg-gradient-to-r ${E(t)} text-white shadow-lg`:"bg-gray-100 text-gray-700 hover:bg-gray-200"),children:s},s)})})]},e.key))]}),m.jsx("div",{className:"bg-blue-50 p-4 rounded-lg",children:m.jsxs("div",{className:"flex items-start space-x-2",children:[m.jsx(U,{className:"h-5 w-5 text-blue-500 mt-0.5"}),m.jsxs("div",{children:[m.jsx("p",{className:"text-sm text-blue-800 font-medium",children:"Informaci칩n"}),m.jsx("p",{className:"text-sm text-blue-700",children:"Personaliza cada video individualmente y aplica etiquetas que se usar치n para todos los videos seleccionados."})]})]})})]}),re=()=>m.jsxs("div",{className:"space-y-4",children:[m.jsxs("div",{className:"text-center",children:[m.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Subiendo Videos"}),m.jsxs("p",{className:"text-gray-600",children:["Procesando ",S.length," video(s)..."]})]}),S.map((e,s)=>m.jsxs("div",{className:"space-y-2",children:[m.jsxs("div",{className:"flex items-center justify-between",children:[m.jsx("span",{className:"font-medium text-gray-900",children:e.name}),m.jsxs("span",{className:"text-sm text-gray-500",children:[V[s]||0,"%"]})]}),m.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:m.jsx("div",{className:`bg-gradient-to-r ${E(t)} h-2 rounded-full transition-all duration-300`,style:{width:`${V[s]||0}%`}})})]},s))]});return e?m.jsxs(m.Fragment,{children:[m.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:m.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-hidden",children:[m.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[m.jsxs("div",{className:"flex items-center space-x-3",children:[m.jsx("div",{className:`p-2 bg-gradient-to-r ${E(t)} rounded-full`,children:m.jsx(j,{className:"h-6 w-6 text-white"})}),m.jsxs("div",{children:[m.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Subir Videos"}),m.jsxs("p",{className:"text-sm text-gray-500",children:["Paso ",B," de 3"]})]})]}),m.jsx("button",{onClick:s,className:"text-gray-400 hover:text-gray-600 transition-colors duration-200",children:m.jsx(w,{className:"h-6 w-6"})})]}),m.jsx("div",{className:"p-6 overflow-y-auto max-h-[60vh]",children:(()=>{switch(B){case 1:default:return m.jsx(se,{});case 2:return m.jsx(ae,{});case 3:return m.jsx(re,{})}})()}),m.jsxs("div",{className:"flex items-center justify-between p-6 border-t border-gray-200",children:[m.jsx("button",{onClick:()=>{F(e=>Math.max(1,e-1))},disabled:1===B||T,className:"px-4 py-2 text-gray-700 border border-gray-300 rounded-lg font-medium hover:bg-gray-50 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed",children:"Atr치s"}),m.jsxs("div",{className:"flex space-x-3",children:[m.jsx("button",{onClick:s,disabled:T,className:"px-4 py-2 text-gray-700 border border-gray-300 rounded-lg font-medium hover:bg-gray-50 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed",children:"Cancelar"}),B<3&&m.jsx("button",{onClick:()=>{2===B?c(void 0,null,function*(){if(0===S.length)return void J("Selecciona al menos un video","error");z(!0);const e=[];for(let s=0;s<S.length;s++){const a=S[s],r=yield ee(a,s);r&&e.push(r)}z(!1),e.length>0&&(J(`${e.length} video(s) subido(s) correctamente`,"success"),e.forEach(e=>a(e)),s())}):(F(e=>e+1),1===B&&K(new Set(S.map(e=>e.name))))},disabled:!(()=>{switch(B){case 1:return S.length>0;case 2:return!0;default:return!1}})()||T,className:`px-6 py-2 bg-gradient-to-r ${E(t)} text-white rounded-lg font-medium hover:shadow-lg transition-all duration-200 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none`,children:2===B?"Subir Videos":"Siguiente"})]})]})]})}),A.map(e=>m.jsx(f,{message:e.message,type:e.type,onClose:()=>{return s=e.id,void _(e=>e.filter(e=>e.id!==s));var s}},e.id))]}):null};export{L as default};
