var e=(e,t,r)=>new Promise((o,a)=>{var l=e=>{try{s(r.next(e))}catch(t){a(t)}},n=e=>{try{s(r.throw(e))}catch(t){a(t)}},s=e=>e.done?o(e.value):Promise.resolve(e.value).then(l,n);s((r=r.apply(e,t)).next())});import{w as t,x as r,y as o,z as a,A as l,B as n,C as s,D as i,E as u,F as d,G as c,H as m,I as h,J as g,K as v,L as f,M as p}from"../assets/index-_E1YfA--.js";import{l as y,r as b,C as w,D as E,E as P,F as U}from"./vendor-firebase-DVYjp8kH.js";const I=t=>e(void 0,null,function*(){try{const e=URL.createObjectURL(t),r=document.createElement("video");r.crossOrigin="anonymous",r.muted=!0,r.playsInline=!0;const o=document.createElement("canvas"),a=o.getContext("2d");return new Promise((t,l)=>{r.onloadedmetadata=()=>{const n=r.videoWidth/r.videoHeight;let s,i;n>1?(s=1280,i=1280/n):(i=720,s=720*n),o.width=s,o.height=i;const u=r.duration;r.currentTime=Math.min(.5*u,1),r.onseeked=()=>{try{a.drawImage(r,0,0,o.width,o.height),o.toBlob(a=>{if(a){const l=URL.createObjectURL(a);URL.revokeObjectURL(e),r.remove(),o.remove(),t({success:!0,thumbnailURL:l,blob:a,error:null})}else l(new Error("No se pudo generar el thumbnail"))},"image/jpeg",.95)}catch(n){l(new Error(`Error al capturar frame: ${n.message}`))}},r.onerror=()=>{l(new Error("Error al cargar el video para thumbnail"))}},r.onerror=()=>{URL.revokeObjectURL(e),r.remove(),o.remove(),l(new Error("Error al cargar el video"))},r.src=e})}catch(e){return{success:!1,thumbnailURL:"https://via.placeholder.com/300x200/1a1a1a/ffffff?text=VIDEO",blob:null,error:e.message}}}),L=(r,o,a)=>e(void 0,null,function*(){try{const e=b(t,o),a={contentType:r.type,customMetadata:{uploadedAt:(new Date).toISOString(),originalName:r.name,fileSize:r.size.toString()}},l=yield P(e,r,a);return{success:!0,url:yield E(l.ref),path:l.ref.fullPath,error:null}}catch(e){return{success:!1,url:null,path:null,error:e.message}}}),$=(t,r,...o)=>e(void 0,[t,r,...o],function*(e,t,r=1048576){try{let o=e;if(e.size>r){o=yield R(e,r)}return yield L(o,t)}catch(o){return{url:null,path:null,error:o.message}}}),R=(e,t)=>new Promise(r=>{const o=document.createElement("canvas"),a=o.getContext("2d"),l=new Image;l.onload=()=>{let{width:n,height:s}=l;const i=Math.min(t/e.size,1);n*=i,s*=i,o.width=n,o.height=s,a.drawImage(l,0,0,n,s),o.toBlob(t=>{const o=new File([t],e.name,{type:e.type,lastModified:Date.now()});r(o)},e.type,.8)},l.src=URL.createObjectURL(e)}),O=r=>e(void 0,null,function*(){try{const e=b(t,r);return{url:yield E(e),error:null}}catch(e){return{url:null,error:e.message}}}),S=r=>e(void 0,null,function*(){try{const e=b(t,r);return yield w(e),{success:!0,error:null}}catch(e){return{success:!1,error:e.message}}}),x=(r,o,a)=>e(void 0,null,function*(){try{if(!r.type.startsWith("video/"))throw new Error("El archivo debe ser un video");const n=524288e3;if(r.size>n)throw new Error("El video es demasiado grande. M치ximo 500MB");const s={contentType:r.type,customMetadata:{uploadedAt:(new Date).toISOString(),originalName:r.name,fileSize:r.size.toString(),fileType:"video"}},i=b(t,o);try{const e=yield P(i,r,s);return{success:!0,url:yield E(e.ref),path:e.ref.fullPath,error:null,simulated:!1}}catch(l){const t=U(i,r,s);return new Promise((r,o)=>{t.on("state_changed",e=>{const t=e.bytesTransferred/e.totalBytes*100;a&&a(t)},e=>{let t="Error al subir el video";"storage/unauthorized"===e.code?t="No tienes permisos para subir videos":"storage/quota-exceeded"===e.code?t="Se ha excedido la cuota de almacenamiento":"storage/retry-limit-exceeded"===e.code?t="Error de conexi칩n. Intenta de nuevo":"storage/canceled"===e.code?t="Upload cancelado":e.message&&(t=e.message),r({success:!1,url:null,path:null,error:t,simulated:!1})},()=>e(void 0,null,function*(){try{const e=yield E(t.snapshot.ref);r({success:!0,url:e,path:t.snapshot.ref.fullPath,error:null,simulated:!1})}catch(e){r({success:!1,url:null,path:null,error:"Error al obtener la URL del video",simulated:!1})}}))})}}catch(n){let e="Error al subir el video";return"storage/unauthorized"===n.code?e="No tienes permisos para subir videos":"storage/quota-exceeded"===n.code?e="Se ha excedido la cuota de almacenamiento":"storage/retry-limit-exceeded"===n.code?e="Error de conexi칩n. Intenta de nuevo":n.message&&(e=n.message),{success:!1,url:null,path:null,error:e,simulated:!1}}}),z=(r,o)=>e(void 0,null,function*(){try{const e=[];if(r){const o=b(t,r);e.push(w(o))}if(o&&null!==o&&""!==o){const r=b(t,o);e.push(w(r))}return 0===e.length?{success:!0,error:null,deletedCount:0}:(yield Promise.all(e),{success:!0,error:null,deletedCount:e.length})}catch(e){return{success:!1,error:e.message,deletedCount:0}}}),D=()=>e(void 0,null,function*(){try{const e=yield M("videos"),t=yield M("thumbnails");return{success:!0,videosDeleted:e.deletedCount,thumbnailsDeleted:t.deletedCount,error:null}}catch(e){return{success:!1,videosDeleted:0,thumbnailsDeleted:0,error:e.message}}}),M=r=>e(void 0,null,function*(){try{const o=b(t,r),a=yield y(o);if(0===a.items.length)return{success:!0,deletedCount:0,error:null};const l=a.items.map(t=>e(void 0,null,function*(){try{return yield w(t),{success:!0,path:t.fullPath}}catch(e){return{success:!1,path:t.fullPath,error:e.message}}})),n=yield Promise.all(l),s=n.filter(e=>e.success).length,i=n.filter(e=>!e.success).length;return{success:!0,deletedCount:s,failedCount:i,error:null}}catch(o){return{success:!1,deletedCount:0,failedCount:0,error:o.message}}}),j=r=>e(void 0,null,function*(){try{const e=yield y(b(t,"videos")),o=yield y(b(t,"thumbnails")),a=new Set(r.map(e=>e.videoPath).filter(Boolean)),l=new Set(r.map(e=>e.thumbnailPath).filter(Boolean)),n=e.items.filter(e=>!a.has(e.fullPath)),s=o.items.filter(e=>!l.has(e.fullPath)),i=[...n.map(e=>w(e)),...s.map(e=>w(e))];return i.length>0&&(yield Promise.all(i)),{success:!0,orphanedVideosDeleted:n.length,orphanedThumbnailsDeleted:s.length,error:null}}catch(e){return{success:!1,orphanedVideosDeleted:0,orphanedThumbnailsDeleted:0,error:e.message}}}),F=r=>e(void 0,null,function*(){try{const e=b(t,r),o=yield E(e),a=yield fetch(o);if(!a.ok)throw new Error(`Error al descargar archivo: ${a.status}`);return yield a.blob()}catch(e){throw e}}),T=(e,t)=>new File([e],t,{type:e.type}),C=t=>e(void 0,null,function*(){try{const r=[];for(const n of t)try{if(n.videoPath&&n.videoPath.includes("/figuras/")||n.videoPath&&n.videoPath.includes("/escuela/")||n.videoPath&&n.videoPath.includes("/eventos/")){r.push({videoId:n.id,title:n.title,status:"already_organized",error:null});continue}const t=n.style||"salsa",o="figuras",a=n.videoPath,l=n.thumbnailPath,s=`videos/${o}/${t}/${a.split("/").pop()}`,i=l?`thumbnails/${o}/${t}/${l.split("/").pop()}`:null;let u=!1,d=!1;try{const e=yield F(a),t=T(e,a.split("/").pop());yield L(t,s),u=!0,yield S(a)}catch(e){throw new Error(`Error migrando video: ${e.message}`)}if(l&&i)try{const e=yield F(l),t=T(e,l.split("/").pop());yield L(t,i),d=!0,yield S(l)}catch(e){}r.push({videoId:n.id,title:n.title,oldVideoPath:a,newVideoPath:s,oldThumbnailPath:l,newThumbnailPath:i,status:"migrated",videoMigrated:u,thumbnailMigrated:d,error:null})}catch(e){r.push({videoId:n.id,title:n.title,status:"error",error:e.message})}const o=r.filter(e=>"migrated"===e.status).length,a=r.filter(e=>"already_organized"===e.status).length,l=r.filter(e=>"error"===e.status).length;return{success:!0,totalVideos:t.length,successfulMigrations:o,alreadyOrganized:a,failedMigrations:l,results:r,error:null}}catch(e){return{success:!1,totalVideos:0,successfulMigrations:0,alreadyOrganized:0,failedMigrations:0,results:[],error:e.message}}}),_=Object.freeze(Object.defineProperty({__proto__:null,cleanupOrphanedFiles:j,deleteAllFilesInFolder:M,deleteAllVideoFiles:D,deleteFile:S,deleteVideo:z,generateBestVideoThumbnail:I,generateVideoThumbnail:e=>new Promise((t,r)=>{try{const o=URL.createObjectURL(e),a=document.createElement("video");a.crossOrigin="anonymous",a.muted=!0,a.playsInline=!0;const l=document.createElement("canvas"),n=l.getContext("2d"),s=1280,i=720;a.onloadedmetadata=()=>{try{const e=a.videoWidth/a.videoHeight;let u,d;e>1?(u=s,d=s/e):(d=i,u=i*e),l.width=u,l.height=d;const c=a.duration,m=Math.min(.5*c,1);a.currentTime=m,a.onseeked=()=>{try{n.drawImage(a,0,0,l.width,l.height),l.toBlob(e=>{if(e){const r=URL.createObjectURL(e);URL.revokeObjectURL(o),a.remove(),l.remove(),t({success:!0,thumbnailURL:r,blob:e,error:null})}else r(new Error("No se pudo generar el thumbnail"))},"image/jpeg",.95)}catch(e){r(new Error(`Error al capturar frame: ${e.message}`))}},a.onerror=()=>{r(new Error("Error al cargar el video para thumbnail"))}}catch(e){r(new Error(`Error al procesar metadata: ${e.message}`))}},a.onerror=()=>{URL.revokeObjectURL(o),a.remove(),l.remove(),r(new Error("Error al cargar el video"))},a.src=o}catch(o){r(new Error(`Error al generar thumbnail: ${o.message}`))}}),getFileURL:O,listFiles:r=>e(void 0,null,function*(){try{const o=b(t,r),a=yield y(o);return{files:yield Promise.all(a.items.map(t=>e(void 0,null,function*(){const e=yield E(t);return{name:t.name,path:t.fullPath,url:e}}))),error:null}}catch(o){return{files:[],error:o.message}}}),migrateVideosToOrganizedStructure:C,uploadEventImage:(t,r)=>e(void 0,null,function*(){const e=`events/${r}/${Date.now()}_${t.name}`;return yield $(t,e)}),uploadFigureImage:(t,r)=>e(void 0,null,function*(){const e=`figures/${r}/${Date.now()}_${t.name}`;return yield $(t,e)}),uploadFigureVideo:(t,r)=>e(void 0,null,function*(){const e=`figures/${r}/videos/${Date.now()}_${t.name}`;return yield x(t,e)}),uploadFile:L,uploadImage:$,uploadNoteImage:(t,r)=>e(void 0,null,function*(){const e=`notes/${r}/${Date.now()}_${t.name}`;return yield $(t,e)}),uploadProfileImage:(t,r)=>e(void 0,null,function*(){const e=`profiles/${r}/${Date.now()}_${t.name}`;return yield $(t,e)}),uploadVideo:x,uploadVideoSimulated:(t,r,o)=>e(void 0,null,function*(){try{if(!t.type.startsWith("video/"))throw new Error("El archivo debe ser un video");const e=524288e3;if(t.size>e)throw new Error("El video es demasiado grande. M치ximo 500MB");for(let t=0;t<=100;t+=10)o&&o(t),yield new Promise(e=>setTimeout(e,200));const a=URL.createObjectURL(t),l={uploadedAt:(new Date).toISOString(),originalName:t.name,fileSize:t.size.toString(),fileType:"video",simulated:!0};return{success:!0,url:a,path:r,error:null,simulated:!0,metadata:l}}catch(e){return{success:!1,url:null,path:null,error:e.message,simulated:!0}}})},Symbol.toStringTag,{value:"Module"})),V=Object.freeze(Object.defineProperty({__proto__:null,app:r,auth:o,createInvitation:h,createUserProfile:d,deleteFile:S,deleteInvitation:p,getFileURL:O,getUserInvitations:f,getUserProfile:c,loginWithEmail:l,loginWithGoogle:n,logout:i,markInvitationAsUsed:v,onAuthStateChange:a,registerWithEmail:s,resetPassword:u,updateUserProfile:m,uploadFile:L,validateInvitation:g},Symbol.toStringTag,{value:"Module"}));export{z as a,L as b,j as c,D as d,I as g,V as i,C as m,_ as s,x as u};
