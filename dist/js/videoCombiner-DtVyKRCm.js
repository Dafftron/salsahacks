const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-_E1YfA--.js","js/vendor-react-SlK7pBj5.js","js/vendor-router-UcgXoTZX.js","js/vendor-firebase-DVYjp8kH.js","js/vendor-icons-BWQzNHDY.js","css/index-BkEfCEWI.css"])))=>i.map(i=>d[i]);
var e=(e,t,o)=>new Promise((r,i)=>{var n=e=>{try{s(o.next(e))}catch(t){i(t)}},a=e=>{try{s(o.throw(e))}catch(t){i(t)}},s=e=>e.done?r(e.value):Promise.resolve(e.value).then(n,a);s((o=o.apply(e,t)).next())});import{_ as t}from"../assets/index-_E1YfA--.js";import"./vendor-react-SlK7pBj5.js";import"./vendor-router-UcgXoTZX.js";import"./vendor-firebase-DVYjp8kH.js";import"./vendor-icons-BWQzNHDY.js";class o{constructor(){this.isLoaded=!0,this.maxConcurrentDownloads=3,this.retryAttempts=3}load(){return e(this,null,function*(){return Promise.resolve()})}combineVideosWithFFmpeg(t,o){return e(this,null,function*(){try{if(o&&o({stage:"init",current:0,total:100,message:"Inicializando FFmpeg para máxima compatibilidad..."}),!t||0===t.length)throw new Error("No hay videos para procesar");const e=yield this.downloadVideosWithConcurrency(t,o);o&&o({stage:"ffmpeg",current:70,total:100,message:"Combinando videos con FFmpeg..."});const r=yield this.combineVideosWithFFmpegDirect(e,o);return o&&o({stage:"complete",current:100,total:100,message:"¡Combinación completada con FFmpeg!"}),r}catch(e){throw new Error(`Error combinando videos: ${e.message}`)}})}combineVideosSimple(o,r){return e(this,null,function*(){try{const{FFmpeg:i}=yield t(()=>e(this,null,function*(){const{FFmpeg:e}=yield import("./vendor-ffmpeg-BflpXDox.js").then(e=>e.i);return{FFmpeg:e}}),[]),{toBlobURL:n}=yield t(()=>e(this,null,function*(){const{toBlobURL:e}=yield import("./vendor-ffmpeg-BflpXDox.js").then(e=>e.a);return{toBlobURL:e}}),[]),a=new i;yield a.load({coreURL:yield n("/ffmpeg/ffmpeg-core.js","text/javascript"),wasmURL:yield n("/ffmpeg/ffmpeg-core.wasm","application/wasm")});const s=[];for(let e=0;e<o.length;e++){const t=yield o[e].arrayBuffer(),i=`video_${e}.mp4`;yield a.writeFile(i,new Uint8Array(t)),s.push(i),r&&r({stage:"ffmpeg",current:70+(e+1)/o.length*20,total:100,message:`Preparando video ${e+1}/${o.length}`})}const l=s.map(e=>`file '${e}'`).join("\n");yield a.writeFile("filelist.txt",l);const c=["-f","concat","-safe","0","-i","filelist.txt","-c","copy","-movflags","+faststart","output.mp4"];yield a.exec(c);const d=yield a.readFile("output.mp4");yield this.cleanupFFmpegFiles(a,s);return new Blob([d],{type:"video/mp4"})}catch(i){throw new Error(`Error en combinación simple: ${i.message||"Error desconocido"}`)}})}combineVideosWithMediaRecorder(t,o){return e(this,null,function*(){try{return new Promise((e,r)=>{const i=document.createElement("canvas"),n=i.getContext("2d");i.width=1920,i.height=1080;const a={mimeType:"video/webm;codecs=vp9",videoBitsPerSecond:5e6};MediaRecorder.isTypeSupported(a.mimeType)||(a.mimeType="video/webm;codecs=vp8"),MediaRecorder.isTypeSupported(a.mimeType)||(a.mimeType="video/mp4");const s=new MediaRecorder(i.captureStream(30),a),l=[];let c=0,d=null;const m=()=>{if(c>=t.length)return void s.stop();const e=t[c],i=URL.createObjectURL(e);d=document.createElement("video"),d.src=i,d.muted=!0,d.playsInline=!0,d.onloadedmetadata=()=>{o&&o({stage:"ffmpeg",current:70+(c+1)/t.length*20,total:100,message:`Combinando video ${c+1}/${t.length}`}),d.currentTime=0,d.play()},d.onended=()=>{URL.revokeObjectURL(i),c++,m()},d.onerror=e=>{URL.revokeObjectURL(i),r(new Error(`Error procesando video ${c+1}`))}};s.ondataavailable=e=>{e.data.size>0&&l.push(e.data)},s.onstop=()=>{try{const t=a.mimeType.includes("mp4")?"video/mp4":"video/webm",o=new Blob(l,{type:t});"video/webm"===t?this.convertWebmToMp4Simple(o).then(t=>{e(t)}).catch(t=>{e(o)}):e(o)}catch(t){r(t)}},s.onerror=e=>{r(new Error(`Error en MediaRecorder: ${e.message}`))};const p=()=>{!d||d.paused||d.ended||(n.drawImage(d,0,0,i.width,i.height),requestAnimationFrame(p))};s.start(100),m(),p()})}catch(e){throw new Error(`Error en combinación con MediaRecorder: ${e.message||"Error desconocido"}`)}})}convertWebmToMp4Simple(o){return e(this,null,function*(){try{const{FFmpeg:r}=yield t(()=>e(this,null,function*(){const{FFmpeg:e}=yield import("./vendor-ffmpeg-BflpXDox.js").then(e=>e.i);return{FFmpeg:e}}),[]),{toBlobURL:i}=yield t(()=>e(this,null,function*(){const{toBlobURL:e}=yield import("./vendor-ffmpeg-BflpXDox.js").then(e=>e.a);return{toBlobURL:e}}),[]),n=new r;yield n.load({coreURL:yield i("/ffmpeg/ffmpeg-core.js","text/javascript"),wasmURL:yield i("/ffmpeg/ffmpeg-core.wasm","application/wasm")});const a=yield o.arrayBuffer();yield n.writeFile("input.webm",new Uint8Array(a)),yield n.exec(["-i","input.webm","-c:v","libx264","-preset","fast","-crf","23","-c:a","aac","-b:a","128k","-movflags","+faststart","output.mp4"]);const s=yield n.readFile("output.mp4");yield n.deleteFile("input.webm"),yield n.deleteFile("output.mp4");return new Blob([s],{type:"video/mp4"})}catch(r){throw new Error(`Error en conversión: ${r.message||"Error desconocido"}`)}})}combineVideosWithSeekingSupport(o,r){return e(this,null,function*(){try{const{FFmpeg:i}=yield t(()=>e(this,null,function*(){const{FFmpeg:e}=yield import("./vendor-ffmpeg-BflpXDox.js").then(e=>e.i);return{FFmpeg:e}}),[]),{toBlobURL:n}=yield t(()=>e(this,null,function*(){const{toBlobURL:e}=yield import("./vendor-ffmpeg-BflpXDox.js").then(e=>e.a);return{toBlobURL:e}}),[]),a=new i;yield a.load({coreURL:yield n("/ffmpeg/ffmpeg-core.js","text/javascript"),wasmURL:yield n("/ffmpeg/ffmpeg-core.wasm","application/wasm")});const s=[];for(let e=0;e<o.length;e++){const t=yield o[e].arrayBuffer(),i=`video_${e}.mp4`;yield a.writeFile(i,new Uint8Array(t)),s.push(i),r&&r({stage:"ffmpeg",current:70+(e+1)/o.length*20,total:100,message:`Preparando video ${e+1}/${o.length}`})}const l=s.map(e=>`file '${e}'`).join("\n");yield a.writeFile("filelist.txt",l);const c=["-f","concat","-safe","0","-i","filelist.txt","-c:v","libx264","-preset","ultrafast","-crf","23","-c:a","aac","-b:a","128k","-movflags","+faststart","-metadata","title=Secuencia Combinada","-metadata","artist=SalsaHacks","-g","30","-keyint_min","30","output.mp4"];yield a.exec(c);const d=yield a.readFile("output.mp4");yield this.cleanupFFmpegFiles(a,s);return new Blob([d],{type:"video/mp4"})}catch(i){throw new Error(`Error en combinación con seeking: ${i.message||"Error desconocido"}`)}})}combineVideosWithWindowsSeeking(o,r,i="4k"){return e(this,null,function*(){try{const n=this.getResolutionDimensions(i),{FFmpeg:a}=yield t(()=>e(this,null,function*(){const{FFmpeg:e}=yield import("./vendor-ffmpeg-BflpXDox.js").then(e=>e.i);return{FFmpeg:e}}),[]),{toBlobURL:s}=yield t(()=>e(this,null,function*(){const{toBlobURL:e}=yield import("./vendor-ffmpeg-BflpXDox.js").then(e=>e.a);return{toBlobURL:e}}),[]),l=new a;yield l.load({coreURL:yield s("/ffmpeg/ffmpeg-core.js","text/javascript"),wasmURL:yield s("/ffmpeg/ffmpeg-core.wasm","application/wasm")});const c=[];for(let e=0;e<o.length;e++){const t=yield o[e].arrayBuffer(),i=`video_${e}.mp4`;yield l.writeFile(i,new Uint8Array(t)),c.push(i),r&&r({stage:"ffmpeg",current:70+(e+1)/o.length*20,total:100,message:`Preparando video ${e+1}/${o.length}`})}const d=c.map(e=>`file '${e}'`).join("\n");yield l.writeFile("filelist.txt",d);const m=["-f","concat","-safe","0","-i","filelist.txt","-c:v","libx264","-preset","medium","-crf","18","-c:a","aac","-b:a","160k","-movflags","+faststart","-pix_fmt","yuv420p","-profile:v","high","-level","4.1","-g","25","-keyint_min","25","-vf",`scale=${n.width}:${n.height}:force_original_aspect_ratio=decrease,pad=${n.width}:${n.height}:(ow-iw)/2:(oh-ih)/2`];n.fps&&m.push("-r",n.fps.toString()),m.push("output.mp4"),yield l.exec(m);const p=yield l.readFile("output.mp4");yield this.cleanupFFmpegFiles(l,c);return new Blob([p],{type:"video/mp4"})}catch(n){throw new Error(`Error en combinación con calidad original: ${n.message||"Error desconocido"}`)}})}cleanupFFmpegFiles(t,o){return e(this,null,function*(){try{for(const e of o)yield t.deleteFile(e);yield t.deleteFile("filelist.txt"),yield t.deleteFile("output.mp4")}catch(e){}})}combineVideos(t,o,r="4k"){return e(this,null,function*(){try{o&&o({stage:"init",current:0,total:100,message:"Inicializando procesamiento con Web Workers..."});const n=yield this.downloadVideosWithConcurrency(t,o);if(r)try{o&&o({stage:"ffmpeg",current:60,total:100,message:`Preparando combinación en ${r.toUpperCase()}...`});const e=yield this.combineVideosWithWindowsSeeking(n,o,r);return o&&o({stage:"complete",current:100,total:100,message:"¡Combinación completada (MP4 compatible)!"}),e}catch(e){o&&o({stage:"ffmpeg",current:55,total:100,message:"FFmpeg no disponible. Usando método alternativo…"})}try{o&&o({stage:"combine",current:60,total:100,message:"Combinando con MediaRecorder..."});const e=yield this.combineVideosWithMediaRecorder(n,o);return o&&o({stage:"complete",current:100,total:100,message:"¡Combinación completada!"}),e}catch(i){o&&o({stage:"ffmpeg",current:50,total:100,message:"Procesando videos con Web Workers..."});const e=yield this.combineVideosWithWebWorker(n,o);return o&&o({stage:"complete",current:100,total:100,message:"¡Combinación con Web Workers completada!"}),e}}catch(n){throw new Error(`Error combinando videos: ${n.message||"Error desconocido"}`)}})}combineVideosWithWebWorker(t,o){return e(this,null,function*(){return new Promise((e,r)=>{try{const i=new Worker(new URL("/assets/ffmpegConcatWorker-47-96kDh.js",import.meta.url),{type:"module"});let n=!1;i.onmessage=t=>{const{type:a,message:s,current:l,data:c,error:d}=t.data||{};if("progress"===a&&o&&o({stage:"ffmpeg",current:l||50,total:100,message:s}),"ready"===a&&o&&o({stage:"ffmpeg",current:60,total:100,message:"FFmpeg listo en worker"}),"complete"===a){n=!0;const t=new Blob([c],{type:"video/mp4"});i.terminate(),e(t)}"error"===a&&(n=!0,i.terminate(),r(new Error(d)))},i.onerror=e=>{n||(n=!0,i.terminate(),r(new Error("Error en Web Worker: "+e.message)))},i.postMessage({command:"init"}),Promise.all(t.map(e=>e.arrayBuffer())).then(e=>{i.postMessage({command:"combine",videoBuffers:e})})}catch(i){r(new Error("Error creando Web Worker local: "+((null==i?void 0:i.message)||String(i))))}})})}downloadVideosWithConcurrency(t,o){return e(this,null,function*(){const r=[],i=t.length;for(let n=0;n<t.length;n+=this.maxConcurrentDownloads){const a=t.slice(n,n+this.maxConcurrentDownloads).map((t,r)=>e(this,null,function*(){const e=n+r;return this.downloadVideoWithRetry(t,e,i,o)}));(yield Promise.allSettled(a)).forEach((e,t)=>{if("fulfilled"!==e.status)throw new Error(`Error descargando video: ${e.reason.message}`);r[n+t]=e.value})}return r.filter(e=>void 0!==e)})}downloadVideoWithRetry(o,r,i,n){return e(this,null,function*(){let a;for(let l=1;l<=this.retryAttempts;l++)try{n&&n({stage:"download",current:(r+1)/i*60,total:100,message:`Descargando: ${o.title} (${r+1}/${i})`});const{ref:a,getDownloadURL:s}=yield t(()=>e(this,null,function*(){const{ref:e,getDownloadURL:t}=yield import("./vendor-firebase-DVYjp8kH.js").then(e=>e.J);return{ref:e,getDownloadURL:t}}),[]),{storage:l}=yield t(()=>e(this,null,function*(){const{storage:e}=yield import("../assets/index-_E1YfA--.js").then(e=>e.N);return{storage:e}}),__vite__mapDeps([0,1,2,3,4,5])),c=a(l,o.videoPath),d=yield s(c),m=new AbortController,p=setTimeout(()=>m.abort(),3e4),u=yield fetch(d,{signal:m.signal});if(clearTimeout(p),!u.ok)throw new Error(`Error HTTP: ${u.status} ${u.statusText}`);const f=yield u.blob();if(0===f.size)throw new Error("Archivo de video vacío");return f}catch(s){a=s,l<this.retryAttempts&&(yield new Promise(e=>setTimeout(e,1e3*l)))}throw new Error(`Error descargando video ${o.title} después de ${this.retryAttempts} intentos: ${a.message}`)})}combineVideoBlobsHighQuality(t,o,r="4k"){return e(this,null,function*(){return new Promise((e,r)=>{try{const i=document.createElement("canvas"),n=i.getContext("2d");i.width=3840,i.height=2160;const a=["video/mp4;codecs=h264","video/webm;codecs=h264","video/webm;codecs=vp9","video/webm;codecs=vp8"];let s=null;for(const e of a)if(MediaRecorder.isTypeSupported(e)){s=e;break}if(!s)throw new Error("No se encontró un codec compatible");const l=i.captureStream(60),c=new MediaRecorder(l,{mimeType:s,videoBitsPerSecond:5e7}),d=[];let m=0,p=0,u=0;Date.now();c.ondataavailable=e=>{e.data.size>0&&d.push(e.data)},c.onstop=()=>{try{const t=s.includes("mp4")?"video/mp4":"video/webm",o=new Blob(d,{type:t});"video/webm"===t?this.convertWebmToMp4WithMetadata(o,m).then(t=>{e(t)}).catch(t=>{e(o)}):e(o)}catch(t){r(t)}},c.onerror=e=>{r(new Error(`Error en MediaRecorder: ${e.message}`))},c.start(100);const f=()=>{if(p>=t.length)return void c.stop();const e=t[p],r=URL.createObjectURL(e),a=document.createElement("video");a.onloadedmetadata=()=>{m+=a.duration,a.currentTime=0,a.muted=!1,a.volume=1,a.play()},a.onplay=()=>{const e=()=>{if(!a.paused&&!a.ended){n.imageSmoothingEnabled=!0,n.imageSmoothingQuality="high",n.clearRect(0,0,i.width,i.height);const t=a.videoWidth/a.videoHeight;let o,r,s,l;t>i.width/i.height?(o=i.width,r=i.width/t,s=0,l=(i.height-r)/2):(r=i.height,o=i.height*t,s=(i.width-o)/2,l=0),n.drawImage(a,s,l,o,r),u++,requestAnimationFrame(e)}};requestAnimationFrame(e)},a.onended=()=>{URL.revokeObjectURL(r),p++,u=0,o&&o({stage:"combine",current:70+p/t.length*30,total:100,message:`Procesando video ${p}/${t.length}`}),setTimeout(f,100)},a.src=r};f()}catch(i){r(i)}})})}convertWebmToMp4WithMetadata(o,r){return e(this,null,function*(){try{const{FFmpeg:i}=yield t(()=>e(this,null,function*(){const{FFmpeg:e}=yield import("./vendor-ffmpeg-BflpXDox.js").then(e=>e.i);return{FFmpeg:e}}),[]),{toBlobURL:n}=yield t(()=>e(this,null,function*(){const{toBlobURL:e}=yield import("./vendor-ffmpeg-BflpXDox.js").then(e=>e.a);return{toBlobURL:e}}),[]),a=new i;yield a.load({coreURL:yield n("/ffmpeg/ffmpeg-core.js","text/javascript"),wasmURL:yield n("/ffmpeg/ffmpeg-core.wasm","application/wasm")});const s=yield o.arrayBuffer();yield a.writeFile("input.webm",new Uint8Array(s)),yield a.exec(["-i","input.webm","-c:v","libx264","-preset","slow","-crf","18","-c:a","aac","-b:a","192k","-movflags","+faststart","-metadata",`duration=${r}`,"-metadata","title=Video Combinado","-metadata","artist=SalsaHacks","-metadata","comment=Video combinado con máxima calidad","-map_metadata","0","output.mp4"]);const l=yield a.readFile("output.mp4");yield a.deleteFile("input.webm"),yield a.deleteFile("output.mp4");return new Blob([l],{type:"video/mp4"})}catch(i){throw new Error(`Error en conversión: ${i.message}`)}})}cleanup(t){return e(this,null,function*(){try{for(const e of t)yield this.ffmpeg.deleteFile(e);yield this.ffmpeg.deleteFile("filelist.txt"),yield this.ffmpeg.deleteFile("output.mp4")}catch(e){}})}getVideoInfo(t){return e(this,null,function*(){try{const e=yield fetch(t),o=yield e.blob();return{size:o.size,type:o.type,duration:null}}catch(e){return null}})}getResolutionDimensions(e){switch(e){case"4k":return{width:3840,height:2160,fps:null};case"1080p":default:return{width:1920,height:1080,fps:null};case"720p":return{width:1280,height:720,fps:null};case"480p":return{width:854,height:480,fps:null}}}}export{o as default};
