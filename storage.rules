rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    function isAuth() { return request.auth != null; }
    function userDoc() { return get(/databases/(default)/documents/users/$(request.auth.uid)); }
    function userRole() { return isAuth() ? (userDoc().data.role != null ? userDoc().data.role : 'user') : 'guest'; }
    function isSuper() { return userRole() == 'super_admin'; }
    function isMaese() { return userRole() == 'maese'; }
    function isPrivileged() { return isSuper() || isMaese(); }

    // Videos por página/estilo
    match /videos/{page}/{style}/{fileName=**} {
      allow read: if isAuth();
      allow write: if isAuth() && isPrivileged();
    }

    // Thumbnails por página/estilo
    match /thumbnails/{page}/{style}/{fileName=**} {
      allow read: if isAuth();
      allow write: if isAuth() && isPrivileged();
    }

    // Resto denegado por defecto
    match /{allPaths=**} { allow read, write: if false; }
  }
} 